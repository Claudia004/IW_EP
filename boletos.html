<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cine Online - Comprar Boletos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/estilos.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">Cine Online</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Estrenos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="cartelera.html">Cartelera</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="boletos.html">Comprar Boletos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="compras.html">Mis Compras</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="agradecimiento.html">Agradecimiento</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Formulario de Compra -->
    <section class="py-5">
        <div class="container">
            <h1 class="text-center mb-5">Comprar Boletos</h1>
            
            <div id="alertContainer"></div>
            
            <form id="formCompra">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Información Personal</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="nombre" class="form-label">Nombre Completo</label>
                                    <input type="text" class="form-control" id="nombre" name="nombre" required>
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Selección de Función</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="pelicula" class="form-label">Película</label>
                                    <select class="form-select" id="pelicula" name="pelicula" required>
                                        <option value="">Seleccione una película</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="horario" class="form-label">Horario</label>
                                    <select class="form-select" id="horario" name="horario" required>
                                        <option value="">Seleccione un horario</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Método de Pago</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodo_pago" id="tarjeta" value="tarjeta" required>
                                        <label class="form-check-label" for="tarjeta">
                                            Tarjeta de Crédito/Débito
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodo_pago" id="paypal" value="paypal">
                                        <label class="form-check-label" for="paypal">
                                            PayPal
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodo_pago" id="transferencia" value="transferencia">
                                        <label class="form-check-label" for="transferencia">
                                            Transferencia Bancaria
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Selección de Asientos</h5>
                            </div>
                            <div class="card-body">
                                <div id="salaContainer" class="text-center">
                                    <p class="text-muted">Seleccione una película y horario para ver los asientos disponibles</p>
                                </div>
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>Asientos seleccionados: <span id="contadorAsientos">0</span></span>
                                        <span>Total: $<span id="totalCompra">0.00</span></span>
                                    </div>
                                    <input type="hidden" id="asientosSeleccionados" name="asientos_seleccionados">
                                    <input type="hidden" id="total" name="total">
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body text-center">
                                <button type="submit" class="btn btn-primary btn-lg w-100" id="btnComprar" disabled>
                                    Comprar Boletos
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p>&copy; 2024 Cine Online. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/asientos.js"></script>
    <script>
        // Cargar películas en el select
        function cargarPeliculas() {
            const selectPelicula = document.getElementById('pelicula');
            const peliculas = JSON.parse(localStorage.getItem('peliculas'));
            
            selectPelicula.innerHTML = '<option value="">Seleccione una película</option>' +
                peliculas.map(p => `<option value="${p.id}">${p.titulo}</option>`).join('');
            
            // Si hay parámetro en URL, seleccionar la película
            const urlParams = new URLSearchParams(window.location.search);
            const peliculaId = urlParams.get('pelicula');
            if (peliculaId) {
                selectPelicula.value = peliculaId;
                cargarHorarios(peliculaId);
            }
        }

        // Cargar horarios según película seleccionada
        function cargarHorarios(peliculaId) {
            const selectHorario = document.getElementById('horario');
            const horarios = JSON.parse(localStorage.getItem('horarios'));
            const horariosPelicula = horarios.filter(h => h.pelicula_id == peliculaId);
            
            selectHorario.innerHTML = '<option value="">Seleccione un horario</option>' +
                horariosPelicula.map(h => 
                    `<option value="${h.id}">${h.fecha} ${h.hora} - ${h.sala}</option>`
                ).join('');
        }

        // Configurar eventos
        function configurarEventos() {
            const selectPelicula = document.getElementById('pelicula');
            const selectHorario = document.getElementById('horario');
            
            selectPelicula.addEventListener('change', function() {
                if (this.value) {
                    cargarHorarios(this.value);
                } else {
                    selectHorario.innerHTML = '<option value="">Seleccione un horario</option>';
                    document.getElementById('salaContainer').innerHTML = '<p class="text-muted">Seleccione una película y horario para ver los asientos disponibles</p>';
                }
            });
            
            selectHorario.addEventListener('change', function() {
                if (this.value) {
                    cargarSalaAsientos(this.value);
                } else {
                    document.getElementById('salaContainer').innerHTML = '<p class="text-muted">Seleccione una película y horario para ver los asientos disponibles</p>';
                }
            });
            
            // Manejar envío del formulario
            document.getElementById('formCompra').addEventListener('submit', function(e) {
                e.preventDefault();
                procesarCompra();
            });
        }

        // Procesar compra
        function procesarCompra() {
            const formData = new FormData(document.getElementById('formCompra'));
            const asientosSeleccionados = document.getElementById('asientosSeleccionados').value;
            
            if (!asientosSeleccionados) {
                mostrarAlerta('Por favor seleccione al menos un asiento', 'danger');
                return;
            }

            // Crear objeto de compra
            const compra = {
                id: Date.now(),
                nombre: formData.get('nombre'),
                email: formData.get('email'),
                pelicula_id: parseInt(formData.get('pelicula')),
                horario_id: parseInt(formData.get('horario')),
                asientos: asientosSeleccionados,
                total: parseFloat(document.getElementById('total').value),
                metodo_pago: formData.get('metodo_pago'),
                fecha_compra: new Date().toISOString()
            };

            // Obtener datos de la película y horario
            const peliculas = JSON.parse(localStorage.getItem('peliculas'));
            const horarios = JSON.parse(localStorage.getItem('horarios'));
            const pelicula = peliculas.find(p => p.id === compra.pelicula_id);
            const horario = horarios.find(h => h.id === compra.horario_id);

            compra.pelicula_titulo = pelicula.titulo;
            compra.horario_fecha = horario.fecha;
            compra.horario_hora = horario.hora;
            compra.sala = horario.sala;

            // Guardar compra
            const compras = JSON.parse(localStorage.getItem('compras'));
            compras.push(compra);
            localStorage.setItem('compras', JSON.stringify(compras));

            // Actualizar asientos ocupados
            const asientosOcupados = JSON.parse(localStorage.getItem('asientosOcupados'));
            const key = `${compra.horario_id}`;
            if (!asientosOcupados[key]) {
                asientosOcupados[key] = [];
            }
            asientosOcupados[key] = asientosOcupados[key].concat(compra.asientos.split(','));
            localStorage.setItem('asientosOcupados', JSON.stringify(asientosOcupados));

            // Mostrar mensaje de éxito y redirigir
            mostrarAlerta('¡Compra realizada exitosamente!', 'success');
            setTimeout(() => {
                window.location.href = 'compras.html';
            }, 2000);
        }

        // Mostrar alerta
        function mostrarAlerta(mensaje, tipo) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                    ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        // Inicializar página
        document.addEventListener('DOMContentLoaded', function() {
            cargarPeliculas();
            configurarEventos();
        });
    </script>
</body>
</html>